---
- name: Fix MongoDB Connection for Application
  hosts: app
  become: yes
  vars:
    app_dir: "/home/ubuntu/digital-wardrobe"
    mongodb_user: "wardrobe_user"
    mongodb_password: "wardrobe123"
    mongodb_db: "Digital_Wardrobe"

  tasks:
    - name: Get database instance private IP
      set_fact:
        db_private_ip: "{{ hostvars[groups['database'][0]]['ansible_default_ipv4']['address'] }}"
      when: groups['database'] is defined
      delegate_to: localhost
      run_once: true

    - name: Display database private IP
      debug:
        msg: "Database private IP: {{ db_private_ip }}"

    - name: Update .env file with correct MongoDB URI
      copy:
        content: |
          NODE_ENV=production
          MONGODB_URI=mongodb://{{ mongodb_user }}:{{ mongodb_password }}@{{ db_private_ip }}:27017/{{ mongodb_db }}
          PORT=3000
          S3_BUCKET={{ s3_bucket | default('digital-wardrobe-storage-473a3ff6') }}
          AWS_REGION={{ aws_region | default('ap-south-1') }}
        dest: "{{ app_dir }}/.env.production"
        mode: '0644'

    - name: Update PM2 ecosystem config with correct MongoDB URI
      copy:
        content: |
          module.exports = {
            apps: [{
              name: 'wardrobe-app',
              script: 'npm',
              args: 'start',
              cwd: '{{ app_dir }}',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '1G',
              env: {
                NODE_ENV: 'production',
                PORT: 3000,
                MONGODB_URI: 'mongodb://{{ mongodb_user }}:{{ mongodb_password }}@{{ db_private_ip }}:27017/{{ mongodb_db }}',
                S3_BUCKET: '{{ s3_bucket | default("digital-wardrobe-storage-473a3ff6") }}',
                AWS_REGION: '{{ aws_region | default("ap-south-1") }}'
              },
              error_file: '{{ app_dir }}/logs/err.log',
              out_file: '{{ app_dir }}/logs/out.log',
              log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
              merge_logs: true
            }]
          }
        dest: "{{ app_dir }}/ecosystem.config.js"
        mode: '0644'

    - name: Test MongoDB connection from app instance
      shell: |
        mongosh "mongodb://{{ mongodb_user }}:{{ mongodb_password }}@{{ db_private_ip }}:27017/{{ mongodb_db }}" --quiet --eval "db.stats()"
      register: test_connection
      failed_when: false
      changed_when: false

    - name: Display connection test result
      debug:
        msg: "MongoDB connection test: {{ 'SUCCESS' if test_connection.rc == 0 else 'FAILED - Check database IP and credentials' }}"

    - name: Restart application with updated configuration
      shell: |
        pm2 restart wardrobe-app --update-env
        pm2 save
      args:
        chdir: "{{ app_dir }}"

    - name: Wait for application to restart
      pause:
        seconds: 5

    - name: Check PM2 status
      shell: pm2 status
      register: pm2_status

    - name: Display PM2 status
      debug:
        var: pm2_status.stdout_lines

    - name: Check application logs
      shell: pm2 logs wardrobe-app --lines 30 --nostream
      register: app_logs
      failed_when: false

    - name: Display application logs
      debug:
        var: app_logs.stdout_lines

    - name: Test health endpoint
      uri:
        url: "http://localhost:3000/api/health"
        method: GET
        status_code: [200, 503]
      register: health_check
      failed_when: false

    - name: Display health check result
      debug:
        msg: "Health check: {{ health_check.json | default('Failed to connect') }}"





